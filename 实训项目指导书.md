# Tushare股票数据分析与可视化实训项目指导书

## 前言

本指导书为Tushare股票数据分析与可视化实训项目的配套教程，专为Python和数据分析初学者设计。通过本指导书，你将一步步学习如何使用Python获取股票数据、处理数据、计算技术指标并进行可视化展示。每个步骤都有详细说明、完整代码示例和运行结果展示，帮助你顺利完成实训项目。

本指导书采用循序渐进的方式，从环境搭建开始，到最终完成数据可视化分析，每一步都有详细的解释和操作指南。即使你是编程初学者，也能通过本指导书掌握股票数据分析的基本技能。

## 第一章：环境准备

### 1.1 Python环境安装

#### 1.1.1 安装Python

1. **下载Python安装包**
   - 访问[Python官网](https://www.python.org/downloads/)下载Python 3.7或更高版本
   - 推荐下载最新的稳定版本，如Python 3.10或3.11
   
   ![Python下载页面](https://www.python.org/static/img/python-logo.png)

2. **安装Python**
   - 双击下载的安装文件启动安装程序
   - **重要**：勾选"Add Python to PATH"选项，这样可以在命令行中直接使用Python
   
   ![Python安装选项](https://docs.python.org/3/_images/win_installer.png)
   
   - 点击"Install Now"进行安装
   - 等待安装完成

3. **验证安装**
   - 安装完成后，打开命令提示符(CMD)
   - 输入以下命令验证Python是否正确安装：
   ```
   python --version
   ```
   - 如果显示Python版本号（如`Python 3.10.0`），则表示安装成功

#### 1.1.2 安装项目依赖

1. **下载项目代码**
   - 从提供的链接下载本项目代码
   - 解压到你喜欢的目录，如`D:\tushare\stock_training`

2. **安装依赖库**
   - 打开命令提示符(CMD)
   - 使用`cd`命令进入项目目录：
   ```
   cd D:\tushare\stock_training
   ```
   - 执行以下命令安装依赖库：
   ```
   pip install -r requirements.txt
   ```
   - 等待安装完成，可能需要几分钟时间

3. **依赖库说明**
   项目使用的主要依赖库及其作用：
   - `tushare`: 提供股票数据API接口
   - `pandas`: 用于数据处理和分析
   - `numpy`: 提供数值计算支持
   - `matplotlib`: 用于绘制静态图表
   - `mplfinance`: 专门用于绘制金融图表（K线图等）
   - `plotly`: 用于绘制交互式图表

4. **安装问题解决**
   如果安装过程中遇到网络问题，可以尝试使用国内镜像源：
   ```
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

### 1.2 Tushare账号注册与配置

#### 1.2.1 注册Tushare账号

1. **访问Tushare官网**
   - 打开浏览器，访问[Tushare官网](https://tushare.pro/register)
   - 点击"注册"按钮

2. **填写注册信息**
   - 填写用户名、密码、邮箱等信息
   - 完成注册流程

3. **获取API Token**
   - 登录后，点击右上角的个人中心
   - 在个人中心页面可以看到你的API Token
   - Token是一串字符，如`4e4ec8aab1a625eb5fe52e20e05e3e601fd794ce1297c9bffd55b03a`

#### 1.2.2 配置Token

1. **打开配置文件**
   - 在项目目录中找到`config.py`文件
   - 使用文本编辑器（如记事本、VS Code等）打开该文件

2. **修改Token值**
   - 找到以下代码行：
   ```python
   # 修改前
   TOKEN = "4e4ec8aab1a625eb5fe52e20e05e3e601fd794ce1297c9bffd55b03a"  # 使用原项目的TOKEN
   ```
   
   - 将其修改为：
   ```python
   # 修改后
   TOKEN = "你的Token"  # 替换为你的Tushare Token
   ```
   
   - 将`"你的Token"`替换为你在Tushare个人中心获取的实际Token值
   - 保存文件

3. **验证Token配置**
   - 打开命令提示符(CMD)，进入项目目录
   - 执行以下Python代码验证Token是否正确配置：
   ```
   python -c "import tushare as ts; ts.set_token('你的Token'); print(ts.pro_api().stock_basic(exchange='', list_status='L').head())"
   ```
   - 如果显示股票列表数据，则表示Token配置成功

## 第二章：项目结构与代码解析

### 2.1 项目结构

本项目采用模块化设计，由以下几个主要模块组成：

```
stock_training/
│
├── config.py              # 配置文件
├── data_fetcher.py        # 数据获取模块
├── data_processor.py      # 数据处理模块
├── indicators.py          # 技术指标计算模块
├── visualization.py       # 可视化模块
├── main.py                # 主程序
├── example.py             # 示例脚本
│
├── data/                  # 数据存储目录
│   ├── stock_basic.csv    # 股票基本信息
│   └── daily/             # 日线数据目录
│       └── 000001.SZ.csv  # 个股日线数据
│
├── charts/                # 图表存储目录
│   └── *.html             # 生成的HTML图表
│
└── requirements.txt       # 依赖库列表
```

各模块的主要功能：

- `config.py`：配置文件，包含Tushare Token、数据日期范围、存储路径等配置
- `data_fetcher.py`：数据获取模块，负责从Tushare API获取股票数据
- `data_processor.py`：数据处理模块，负责数据清洗和预处理
- `indicators.py`：技术指标计算模块，实现各种技术指标的计算
- `visualization.py`：可视化模块，负责绘制K线图和技术指标
- `main.py`：主程序，集成各模块功能，提供命令行接口
- `example.py`：示例脚本，展示如何使用各模块功能

### 2.2 核心模块解析

#### 2.2.1 配置模块 (config.py)

配置模块定义了项目的全局配置参数，包括Tushare API Token、数据日期范围、存储路径等。

**完整代码：**

```python
import datetime as dt
import os

# Tushare配置
TOKEN = "4e4ec8aab1a625eb5fe52e20e05e3e601fd794ce1297c9bffd55b03a"  # 使用原项目的TOKEN
START_DATE = "2020-01-01"  # 数据起始日期
END_DATE = dt.datetime.now().strftime("%Y-%m-%d")  # 数据结束日期（当前日期）

# 数据存储路径
# 使用绝对路径确保数据目录正确
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = os.path.join(BASE_DIR, "data")  # 数据存储目录

# 可视化配置
DEFAULT_FIGSIZE = (12, 8)  # 默认图表大小
DEFAULT_STYLE = 'yahoo'  # K线图样式：'yahoo', 'charles', 'binance', 'ibd', 'classic'

# 技术指标配置
DEFAULT_INDICATORS = {
    'macd': True,  # MACD指标
    'rsi': True,   # RSI指标
    'kdj': True,   # KDJ指标
    'boll': True,  # 布林带
    'ma': [5, 10, 20, 30, 60]  # 移动平均线
}
```

**代码解析：**

1. **导入模块**：
   - `datetime`：用于处理日期和时间
   - `os`：用于处理文件路径

2. **Tushare配置**：
   - `TOKEN`：Tushare API的访问令牌
   - `START_DATE`：数据获取的起始日期
   - `END_DATE`：数据获取的结束日期，默认为当前日期

3. **路径配置**：
   - `BASE_DIR`：项目根目录的绝对路径
   - `DATA_DIR`：数据存储目录的绝对路径

4. **可视化配置**：
   - `DEFAULT_FIGSIZE`：图表默认大小
   - `DEFAULT_STYLE`：K线图样式

5. **技术指标配置**：
   - `DEFAULT_INDICATORS`：默认显示的技术指标
   - 包括MACD、RSI、KDJ、布林带和多周期移动平均线

#### 2.2.2 数据获取模块 (data_fetcher.py)

数据获取模块负责从Tushare API获取股票基本信息和历史行情数据。

**核心函数：**

1. **获取股票列表**

```python
def get_stock_basic():
    """获取股票列表数据（排除北交所）"""
    try:
        # 创建数据目录
        ensure_data_dir()
        
        # 获取全量股票列表
        df = pro.stock_basic(
            exchange='', 
            list_status='L',
            fields='ts_code,symbol,name,area,industry,market,list_date,is_hs,delist_date'
        )
        
        # 过滤条件：排除北交所 + 未退市
        df = df[(df['market'] != '北交所') & (df['delist_date'].isna())]
        
        # 保存数据
        if not df.empty:
            filename = os.path.join(DATA_DIR, "stock_basic.csv")
            df.to_csv(filename, index=False)
            logger.info(f"保存{len(df)}条股票数据到 {filename}")
        else:
            logger.warning("获取的股票列表为空")
            
        return df
    
    except Exception as e:
        logger.error(f"获取股票数据失败: {str(e)}")
        return pd.DataFrame()
```

**函数解析：**
- 函数目的：获取当前市场上所有上市股票的基本信息
- 参数说明：无
- 返回值：包含股票基本信息的DataFrame
- 主要步骤：
  1. 确保数据目录存在
  2. 调用Tushare API获取股票列表
  3. 过滤掉北交所股票和已退市股票
  4. 将数据保存到CSV文件
  5. 返回股票列表DataFrame

2. **获取股票日线数据**

```python
def get_daily_data(ts_code=None):
    """获取日线数据
    
    Args:
        ts_code: 股票代码，如果为None则获取所有股票的数据
    """
    # 创建存储目录
    ensure_data_dir()
    
    # 读取股票列表
    stock_list_file = os.path.join(DATA_DIR, 'stock_basic.csv')
    if not os.path.exists(stock_list_file):
        logger.info("股票列表文件不存在，正在获取...")
        get_stock_basic()
    
    stock_list = pd.read_csv(stock_list_file)
    
    # 确定要处理的股票列表
    if ts_code:
        # 如果指定了股票代码，则只处理该股票
        if ts_code in stock_list['ts_code'].values:
            stocks_to_process = [ts_code]
        else:
            logger.error(f"股票代码 {ts_code} 不在股票列表中")
            return {}
    else:
        # 否则处理所有股票
        stocks_to_process = stock_list['ts_code'].tolist()
    
    # 存储结果的字典
    result = {}
    
    # 遍历处理每只股票
    for code in stocks_to_process:
        try:
            # 构建文件路径
            file_path = os.path.join(DATA_DIR, 'daily', f'{code}.csv')
            
            # 确定起始日期
            start_date = START_DATE
            
            # 如果文件已存在，则获取最新的交易日期，只更新新数据
            latest_date = get_latest_trade_date(file_path)
            if latest_date:
                # 将最新日期转换为datetime对象
                latest_dt = datetime.strptime(latest_date, '%Y%m%d')
                # 加一天作为新的起始日期
                start_date = (latest_dt + timedelta(days=1)).strftime('%Y%m%d')
            
            # 如果起始日期大于结束日期，则跳过
            if start_date > END_DATE.replace('-', ''):
                logger.info(f"股票 {code} 数据已是最新，无需更新")
                continue
            
            # 获取日线数据
            logger.info(f"获取股票 {code} 从 {start_date} 到 {END_DATE} 的日线数据")
            df = pro.daily(
                ts_code=code,
                start_date=start_date,
                end_date=END_DATE.replace('-', ''),
                fields='ts_code,trade_date,open,high,low,close,pre_close,change,pct_chg,vol,amount'
            )
            
            # 如果获取到新数据
            if not df.empty:
                # 如果文件已存在，则追加新数据
                if os.path.exists(file_path):
                    # 读取现有数据
                    existing_df = pd.read_csv(file_path)
                    # 合并数据
                    combined_df = pd.concat([existing_df, df], ignore_index=True)
                    # 去重
                    combined_df = combined_df.drop_duplicates(subset=['trade_date'], keep='first')
                    # 按日期排序
                    combined_df = combined_df.sort_values('trade_date', ascending=False)
                    # 保存合并后的数据
                    combined_df.to_csv(file_path, index=False)
                    logger.info(f"更新股票 {code} 数据，新增 {len(df)} 条记录")
                    result[code] = combined_df
                else:
                    # 如果文件不存在，则直接保存
                    df.to_csv(file_path, index=False)
                    logger.info(f"保存股票 {code} 数据，共 {len(df)} 条记录")
                    result[code] = df
            else:
                logger.warning(f"未获取到股票 {code} 的数据")
        
        except Exception as e:
            logger.error(f"获取股票 {code} 数据失败: {str(e)}")
    
    return result
```

**函数解析：**
- 函数目的：获取指定股票或所有股票的日线数据
- 参数说明：
  - `ts_code`：股票代码，如果为None则获取所有股票的数据
- 返回值：包含股票日线数据的字典，键为股票代码，值为对应的DataFrame
- 主要步骤：
  1. 确保数据目录存在
  2. 读取股票列表
  3. 确定要处理的股票列表
  4. 遍历处理每只股票：
     - 确定数据获取的起始日期
     - 调用Tushare API获取日线数据
     - 处理新旧数据的合并和保存
  5. 返回包含股票日线数据的字典

#### 2.2.3 数据处理模块 (data_processor.py)

数据处理模块负责加载、清洗和预处理股票数据，为后续的技术分析和可视化做准备。

**核心函数：**

1. **加载股票数据**

```python
def load_stock_data(ts_code):
    """加载指定股票的日线数据
    
    Args:
        ts_code: 股票代码，如'000001.SZ'
        
    Returns:
        DataFrame: 股票日线数据，如果文件不存在则返回None
    """
    file_path = os.path.join(DATA_DIR, 'daily', f'{ts_code}.csv')
    if not os.path.exists(file_path):
        logger.warning(f"股票 {ts_code} 的数据文件不存在")
        return None
    
    try:
        df = pd.read_csv(file_path)
        return df
    except Exception as e:
        logger.error(f"读取股票 {ts_code} 数据失败: {e}")
        return None
```

**函数解析：**
- 函数目的：从本地文件加载指定股票的日线数据
- 参数说明：
  - `ts_code`：股票代码，如'000001.SZ'
- 返回值：包含股票日线数据的DataFrame，如果文件不存在则返回None
- 主要步骤：
  1. 构建文件路径
  2. 检查文件是否存在
  3. 读取CSV文件数据
  4. 返回DataFrame

2. **处理股票数据**

```python
def process_stock_data(df):
    """处理股票数据，进行必要的转换和清洗
    
    Args:
        df: 原始股票数据DataFrame
        
    Returns:
        DataFrame: 处理后的数据
    """
    if df is None or df.empty:
        return None
    
    # 创建副本，避免修改原始数据
    df = df.copy()
    
    # 转换日期格式
    df['trade_date'] = pd.to_datetime(df['trade_date'], format='%Y%m%d')
    
    # 设置日期为索引
    df.set_index('trade_date', inplace=True)
    
    # 按日期排序
    df.sort_index(inplace=True)
    
    # 处理缺失值
    df.fillna(method='ffill', inplace=True)  # 用前一个值填充
    
    # 确保数值类型正确
    numeric_columns = ['open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
    for col in numeric_columns:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')
    
    # 重命名成交量列名，以便与mplfinance兼容
    if 'vol' in df.columns and 'volume' not in df.columns:
        df['volume'] = df['vol']
    
    return df
```

**函数解析：**
- 函数目的：处理股票数据，进行必要的转换和清洗
- 参数说明：
  - `df`：原始股票数据DataFrame
- 返回值：处理后的DataFrame
- 主要步骤：
  1. 创建数据副本，避免修改原始数据
  2. 转换日期格式并设置为索引
  3. 按日期排序
  4. 处理缺失值
  5. 确保数值类型正确
  6. 重命名成交量列名，以便与mplfinance兼容
  7. 返回处理后的DataFrame

3. **准备可视化数据**

```python
def prepare_data_for_visualization(ts_code, start_date=None, end_date=None):
    """准备用于可视化的数据
    
    Args:
        ts_code: 股票代码
        start_date: 开始日期，格式为'YYYY-MM-DD'，如果为None则使用全部数据
        end_date: 结束日期，格式为'YYYY-MM-DD'，如果为None则使用全部数据
        
    Returns:
        DataFrame: 处理后的数据，适合用于绘制K线图
    """
    # 加载数据
    df = load_stock_data(ts_code)
    if df is None:
        return None
    
    # 处理数据
    df = process_stock_data(df)
    if df is None:
        return None
    
    # 筛选日期范围
    if start_date:
        start_date = pd.to_datetime(start_date)
        df = df[df.index >= start_date]
    
    if end_date:
        end_date = pd.to_datetime(end_date)
        df = df[df.index <= end_date]
    
    # 确保数据不为空
    if df.empty:
        logger.warning(f"筛选后的数据为空，请检查日期范围是否正确")
        return None
    
    return df
```

**函数解析：**
- 函数目的：准备用于可视化的数据
- 参数说明：
  - `ts_code`：股票代码
  - `start_date`：开始日期，格式为'YYYY-MM-DD'
  - `end_date`：结束日期，格式为'YYYY-MM-DD'
- 返回值：处理后的DataFrame，适合用于绘制K线图
- 主要步骤：
  1. 加载股票数据
  2. 处理数据
  3. 筛选日期范围
  4. 确保数据不为空
  5. 返回处理后的DataFrame

#### 2.2.4 技术指标计算模块 (indicators.py)

技术指标计算模块负责计算各种技术指标，包括移动平均线、MACD、RSI、KDJ和布林带等。

**核心函数：**

1. **计算移动平均线**

```python
def calculate_ma(df, periods=[5, 10, 20, 30, 60]):
    """
    计算移动平均线
    
    Args:
        df: 包含'close'列的DataFrame
        periods: 移动平均的周期列表，默认为[5, 10, 20, 30, 60]
        
    Returns:
        DataFrame: 添加了移动平均线的DataFrame
    """
    result = df.copy()
    for period in periods:
        result[f'ma{period}'] = result['close'].rolling(window=period).mean()
    return result
```

**函数解析：**
- 函数目的：计算移动平均线
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `periods`：移动平均的周期列表，默认为[5, 10, 20, 30, 60]
- 返回值：添加了移动平均线的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 遍历周期列表，计算每个周期的移动平均线
  3. 返回添加了移动平均线的DataFrame

2. **计算MACD指标**

```python
def calculate_macd(df, fast_period=12, slow_period=26, signal_period=9):
    """
    计算MACD指标
    
    Args:
        df: 包含'close'列的DataFrame
        fast_period: 快线周期，默认为12
        slow_period: 慢线周期，默认为26
        signal_period: 信号线周期，默认为9
        
    Returns:
        DataFrame: 添加了MACD指标的DataFrame
    """
    result = df.copy()
    
    # 计算快线和慢线的指数移动平均
    ema_fast = result['close'].ewm(span=fast_period, adjust=False).mean()
    ema_slow = result['close'].ewm(span=slow_period, adjust=False).mean()
    
    # 计算MACD线和信号线
    result['macd'] = ema_fast - ema_slow
    result['macd_signal'] = result['macd'].ewm(span=signal_period, adjust=False).mean()
    
    # 计算MACD柱状图
    result['macd_hist'] = result['macd'] - result['macd_signal']
    
    return result
```

**函数解析：**
- 函数目的：计算MACD指标
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `fast_period`：快线周期，默认为12
  - `slow_period`：慢线周期，默认为26
  - `signal_period`：信号线周期，默认为9
- 返回值：添加了MACD指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算快线和慢线的指数移动平均
  3. 计算MACD线和信号线
  4. 计算MACD柱状图
  5. 返回添加了MACD指标的DataFrame

3. **计算RSI指标**

```python
def calculate_rsi(df, periods=14):
    """
    计算RSI指标
    
    Args:
        df: 包含'close'列的DataFrame
        periods: RSI周期，默认为14
        
    Returns:
        DataFrame: 添加了RSI指标的DataFrame
    """
    result = df.copy()
    
    # 计算价格变化
    delta = result['close'].diff()
    
    # 分离上涨和下跌
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    
    # 计算平均上涨和下跌
    avg_gain = gain.rolling(window=periods).mean()
    avg_loss = loss.rolling(window=periods).mean()
    
    # 计算相对强度
    rs = avg_gain / avg_loss
    
    # 计算RSI
    result['rsi'] = 100 - (100 / (1 + rs))
    
    return result
```

**函数解析：**
- 函数目的：计算相对强弱指标(RSI)
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `periods`：RSI周期，默认为14
- 返回值：添加了RSI指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算价格变化
  3. 分离上涨和下跌
  4. 计算平均上涨和下跌
  5. 计算相对强度
  6. 计算RSI值
  7. 返回添加了RSI指标的DataFrame

4. **计算KDJ指标**

```python
def calculate_kdj(df, k_period=9, d_period=3, j_period=3):
    """
    计算KDJ指标
    
    Args:
        df: 包含'high', 'low', 'close'列的DataFrame
        k_period: K线周期，默认为9
        d_period: D线周期，默认为3
        j_period: J线周期，默认为3
        
    Returns:
        DataFrame: 添加了KDJ指标的DataFrame
    """
    result = df.copy()
    
    # 计算最低价和最高价
    low_min = result['low'].rolling(window=k_period).min()
    high_max = result['high'].rolling(window=k_period).max()
    
    # 计算RSV
    rsv = 100 * ((result['close'] - low_min) / (high_max - low_min))
    
    # 计算K值、D值和J值
    result['kdj_k'] = rsv.ewm(alpha=1/d_period, adjust=False).mean()
    result['kdj_d'] = result['kdj_k'].ewm(alpha=1/j_period, adjust=False).mean()
    result['kdj_j'] = 3 * result['kdj_k'] - 2 * result['kdj_d']
    
    return result
```

**函数解析：**
- 函数目的：计算KDJ指标
- 参数说明：
  - `df`：包含'high', 'low', 'close'列的DataFrame
  - `k_period`：K线周期，默认为9
  - `d_period`：D线周期，默认为3
  - `j_period`：J线周期，默认为3
- 返回值：添加了KDJ指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算最低价和最高价
  3. 计算RSV值
  4. 计算K值、D值和J值
  5. 返回添加了KDJ指标的DataFrame

5. **计算布林带指标**

```python
def calculate_bollinger_bands(df, period=20, std_dev=2):
    """
    计算布林带指标
    
    Args:
        df: 包含'close'列的DataFrame
        period: 移动平均周期，默认为20
        std_dev: 标准差倍数，默认为2
        
    Returns:
        DataFrame: 添加了布林带指标的DataFrame
    """
    result = df.copy()
    
    # 计算移动平均线
    result['boll_mid'] = result['close'].rolling(window=period).mean()
    
    # 计算标准差
    result['boll_std'] = result['close'].rolling(window=period).std()
    
    # 计算上轨和下轨
    result['boll_upper'] = result['boll_mid'] + (result['boll_std'] * std_dev)
    result['boll_lower'] = result['boll_mid'] - (result['boll_std'] * std_dev)
    
    return result
```

**函数解析：**
- 函数目的：计算布林带指标
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `period`：移动平均周期，默认为20
  - `std_dev`：标准差倍数，默认为2
- 返回值：添加了布林带指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算移动平均线（中轨）
  3. 计算标准差
  4. 计算上轨和下轨
  5. 返回添加了布林带指标的DataFrame

6. **计算所有指标**

```python
def calculate_all_indicators(df, indicators=None):
    """
    计算所有技术指标
    
    Args:
        df: 包含OHLC数据的DataFrame
        indicators: 要计算的指标配置，默认使用config中的DEFAULT_INDICATORS
        
    Returns:
        DataFrame: 添加了所有技术指标的DataFrame
    """
    if df is None or df.empty:
        return None
    
    # 使用默认指标配置（如果未指定）
    if indicators is None:
        from config import DEFAULT_INDICATORS
        indicators = DEFAULT_INDICATORS
    
    result = df.copy()
    
    # 计算移动平均线
    if 'ma' in indicators and indicators['ma']:
        result = calculate_ma(result, periods=indicators['ma'])
    
    # 计算MACD
    if 'macd' in indicators and indicators['macd']:
        result = calculate_macd(result)
    
    # 计算RSI
    if 'rsi' in indicators and indicators['rsi']:
        result = calculate_rsi(result)
    
    # 计算KDJ
    if 'kdj' in indicators and indicators['kdj']:
        result = calculate_kdj(result)
    
    # 计算布林带
    if 'boll' in indicators and indicators['boll']:
        result = calculate_bollinger_bands(result)
    
    # 计算成交量移动平均
    if 'volume' in result.columns:
        result = calculate_volume_ma(result)
    
    return result
```

**函数解析：**
- 函数目的：计算所有技术指标
- 参数说明：
  - `df`：包含OHLC数据的DataFrame
  - `indicators`：要计算的指标配置，默认使用config中的DEFAULT_INDICATORS
- 返回值：添加了所有技术指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 根据配置计算各种技术指标
  3. 返回添加了所有技术指标的DataFrame

#### 2.2.5 可视化模块 (visualization.py)

可视化模块负责绘制K线图和技术指标，提供了静态图表和交互式HTML图表两种可视化方式。

**核心函数：**

1. **绘制基本K线图**

```python
def plot_candlestick(df, title=None, volume=True, savefig=None, show_figure=True):
    """
    绘制K线图
    
    Args:
        df: 包含OHLCV数据的DataFrame，索引为日期
        title: 图表标题，默认为None
        volume: 是否显示成交量，默认为True
        savefig: 保存图表的文件路径，默认为None（不保存）
        show_figure: 是否显示图表，默认为True
        
    Returns:
        fig: matplotlib图表对象
        ax: matplotlib轴对象
    """
    if df is None or df.empty:
        logger.error("数据为空，无法绘制K线图")
        return None, None
    
    # 设置图表样式
    mc = mpf.make_marketcolors(
        up='red',
        down='green',
        edge='inherit',
        wick='inherit',
        volume='inherit'
    )
    
    s = mpf.make_mpf_style(
        base_mpf_style=DEFAULT_STYLE,
        marketcolors=mc
    )
    
    # 设置图表参数
    kwargs = {
        'type': 'candle',
        'style': s,
        'figsize': DEFAULT_FIGSIZE,
        'title': title,
        'returnfig': True
    }
    
    # 添加成交量
    if volume and 'volume' in df.columns:
        kwargs['volume'] = True
        kwargs['panel_ratios'] = (4, 1)  # 主图和成交量图的比例
    
    # 绘制K线图
    fig, axes = mpf.plot(df, **kwargs)
    
    # 保存图表
    if savefig:
        plt.savefig(savefig)
        logger.info(f"图表已保存至 {savefig}")
    
    # 显示图表
    if show_figure:
        plt.show()
    
    return fig, axes
  5. 返回添加了MACD指标的DataFrame

3. **计算RSI指标**

```python
def calculate_rsi(df, periods=14):
    """
    计算RSI指标
    
    Args:
        df: 包含'close'列的DataFrame
        periods: RSI周期，默认为14
        
    Returns:
        DataFrame: 添加了RSI指标的DataFrame
    """
    result = df.copy()
    
    # 计算价格变化
    delta = result['close'].diff()
    
    # 分离上涨和下跌
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    
    # 计算平均上涨和下跌
    avg_gain = gain.rolling(window=periods).mean()
    avg_loss = loss.rolling(window=periods).mean()
    
    # 计算相对强度
    rs = avg_gain / avg_loss
    
    # 计算RSI
    result['rsi'] = 100 - (100 / (1 + rs))
    
    return result
```

**函数解析：**
- 函数目的：计算相对强弱指标(RSI)
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `periods`：RSI周期，默认为14
- 返回值：添加了RSI指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算价格变化
  3. 分离上涨和下跌
  4. 计算平均上涨和下跌
  5. 计算相对强度
  6. 计算RSI值
  7. 返回添加了RSI指标的DataFrame

4. **计算KDJ指标**

```python
def calculate_kdj(df, k_period=9, d_period=3, j_period=3):
    """
    计算KDJ指标
    
    Args:
        df: 包含'high', 'low', 'close'列的DataFrame
        k_period: K线周期，默认为9
        d_period: D线周期，默认为3
        j_period: J线周期，默认为3
        
    Returns:
        DataFrame: 添加了KDJ指标的DataFrame
    """
    result = df.copy()
    
    # 计算最低价和最高价
    low_min = result['low'].rolling(window=k_period).min()
    high_max = result['high'].rolling(window=k_period).max()
    
    # 计算RSV
    rsv = 100 * ((result['close'] - low_min) / (high_max - low_min))
    
    # 计算K值、D值和J值
    result['kdj_k'] = rsv.ewm(alpha=1/d_period, adjust=False).mean()
    result['kdj_d'] = result['kdj_k'].ewm(alpha=1/j_period, adjust=False).mean()
    result['kdj_j'] = 3 * result['kdj_k'] - 2 * result['kdj_d']
    
    return result
```

**函数解析：**
- 函数目的：计算KDJ指标
- 参数说明：
  - `df`：包含'high', 'low', 'close'列的DataFrame
  - `k_period`：K线周期，默认为9
  - `d_period`：D线周期，默认为3
  - `j_period`：J线周期，默认为3
- 返回值：添加了KDJ指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算最低价和最高价
  3. 计算RSV值
  4. 计算K值、D值和J值
  5. 返回添加了KDJ指标的DataFrame

5. **计算布林带指标**

```python
def calculate_bollinger_bands(df, period=20, std_dev=2):
    """
    计算布林带指标
    
    Args:
        df: 包含'close'列的DataFrame
        period: 移动平均周期，默认为20
        std_dev: 标准差倍数，默认为2
        
    Returns:
        DataFrame: 添加了布林带指标的DataFrame
    """
    result = df.copy()
    
    # 计算移动平均线
    result['boll_mid'] = result['close'].rolling(window=period).mean()
    
    # 计算标准差
    result['boll_std'] = result['close'].rolling(window=period).std()
    
    # 计算上轨和下轨
    result['boll_upper'] = result['boll_mid'] + (result['boll_std'] * std_dev)
    result['boll_lower'] = result['boll_mid'] - (result['boll_std'] * std_dev)
    
    return result
```

**函数解析：**
- 函数目的：计算布林带指标
- 参数说明：
  - `df`：包含'close'列的DataFrame
  - `period`：移动平均周期，默认为20
  - `std_dev`：标准差倍数，默认为2
- 返回值：添加了布林带指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 计算移动平均线（中轨）
  3. 计算标准差
  4. 计算上轨和下轨
  5. 返回添加了布林带指标的DataFrame

6. **计算所有指标**

```python
def calculate_all_indicators(df, indicators=None):
    """
    计算所有技术指标
    
    Args:
        df: 包含OHLC数据的DataFrame
        indicators: 要计算的指标配置，默认使用config中的DEFAULT_INDICATORS
        
    Returns:
        DataFrame: 添加了所有技术指标的DataFrame
    """
    if df is None or df.empty:
        return None
    
    # 使用默认指标配置（如果未指定）
    if indicators is None:
        from config import DEFAULT_INDICATORS
        indicators = DEFAULT_INDICATORS
    
    result = df.copy()
    
    # 计算移动平均线
    if 'ma' in indicators and indicators['ma']:
        result = calculate_ma(result, periods=indicators['ma'])
    
    # 计算MACD
    if 'macd' in indicators and indicators['macd']:
        result = calculate_macd(result)
    
    # 计算RSI
    if 'rsi' in indicators and indicators['rsi']:
        result = calculate_rsi(result)
    
    # 计算KDJ
    if 'kdj' in indicators and indicators['kdj']:
        result = calculate_kdj(result)
    
    # 计算布林带
    if 'boll' in indicators and indicators['boll']:
        result = calculate_bollinger_bands(result)
    
    # 计算成交量移动平均
    if 'volume' in result.columns:
        result = calculate_volume_ma(result)
    
    return result
```

**函数解析：**
- 函数目的：计算所有技术指标
- 参数说明：
  - `df`：包含OHLC数据的DataFrame
  - `indicators`：要计算的指标配置，默认使用config中的DEFAULT_INDICATORS
- 返回值：添加了所有技术指标的DataFrame
- 主要步骤：
  1. 创建数据副本
  2. 根据配置计算各种技术指标
  3. 返回添加了所有技术指标的DataFrame

#### 2.2.5 可视化模块 (visualization.py)

可视化模块负责绘制K线图和技术指标，提供了静态图表和交互式HTML图表两种可视化方式。

**核心函数：**

1. **绘制基本K线图**

```python
def plot_candlestick(df, title=None, volume=True, savefig=None, show_figure=True):
    """
    绘制K线图
    
    Args:
        df: 包含OHLCV数据的DataFrame，索引为日期
        title: 图表标题，默认为None
        volume: 是否显示成交量，默认为True
        savefig: 保存图表的文件路径，默认为None（不保存）
        show_figure: 是否显示图表，默认为True
        
    Returns:
        fig: matplotlib图表对象
        ax: matplotlib轴对象
    """
    if df is None or df.empty:
        logger.error("数据为空，无法绘制K线图")
        return None, None
    
    # 设置图表样式
    mc = mpf.make_marketcolors(
        up='red',
        down='green',
        edge='inherit',
        wick='inherit',
        volume='inherit'
    )
    
    s = mpf.make_mpf_style(
        base_mpf_style=DEFAULT_STYLE,
        marketcolors=mc
    )
    
    # 设置图表参数
    kwargs = {
        'type': 'candle',
        'style': s,
        'figsize': DEFAULT_FIGSIZE,
        'title': title,
        'returnfig': True
    }
    
    # 添加成交量
    if volume and 'volume' in df.columns:
        kwargs['volume'] = True
        kwargs['panel_ratios'] = (4, 1)  # 主图和成交量图的比例
    
    # 绘制K线图
    fig, axes = mpf.plot(df, **kwargs)
    
    # 保存图表
    if savefig:
        plt.savefig(savefig)
        logger.info(f"图表已保存至 {savefig}")
    
    # 显示图表
    if show_figure:
        plt.show()
    
    return fig, axes
```

**函数解析：**
- 函数目的：绘制K线图
- 参数说明：
  - `df`：包含OHLCV数据的DataFrame，索引为日期
  - `title`：图表标题
  - `volume`：是否显示成交量
  - `savefig`：保存图表的文件路径
  - `show_figure`：是否显示图表
- 返回值：matplotlib图表对象和轴对象
- 主要步骤：
  1. 检查数据是否为空
  2. 设置图表样式
  3. 设置图表参数
  4. 绘制K线图
  5. 保存图表（如果需要）
  6. 显示图表（如果需要）
  7. 返回图表对象和轴对象

2. **绘制带技术指标的K线图**

```python
def plot_with_indicators(df, title=None, indicators=None, savefig=None, show_figure=True):
    """
    绘制带有技术指标的K线图
    
    Args:
        df: 包含OHLCV和技术指标数据的DataFrame，索引为日期
        title: 图表标题，默认为None
        indicators: 要显示的指标字典，默认使用config中的DEFAULT_INDICATORS
        savefig: 保存图表的文件路径，默认为None（不保存）
        show_figure: 是否显示图表，默认为True
        
    Returns:
        fig: matplotlib图表对象
        axes: matplotlib轴对象列表
    """
    if df is None or df.empty:
        logger.error("数据为空，无法绘制K线图")
        return None, None
    
    # 使用默认指标配置（如果未指定）
    if indicators is None:
        indicators = DEFAULT_INDICATORS
    
    # 设置图表样式
    mc = mpf.make_marketcolors(
        up='red',
        down='green',
        edge='inherit',
        wick='inherit',
        volume='inherit'
    )
    
    s = mpf.make_mpf_style(
        base_mpf_style=DEFAULT_STYLE,
        marketcolors=mc
    )
    
    # 准备附加图表
    panels = []
    
    # 添加成交量面板
    if 'volume' in df.columns:
        panels.append({
            'panel': 1,
            'ylabel': '成交量',
            'mav': (5, 10) if 'volume_ma5' in df.columns and 'volume_ma10' in df.columns else None
        })
    
    # 添加MACD指标
    if indicators.get('macd', False) and 'macd' in df.columns:
        panels.append({
            'panel': 2,
            'ylabel': 'MACD',
            'secondary_y': False,
            'type': 'line',
            'mav': None
        })
    
    # 添加RSI指标
    if indicators.get('rsi', False) and 'rsi' in df.columns:
        panels.append({
            'panel': 3,
            'ylabel': 'RSI',
            'secondary_y': False,
            'type': 'line',
            'mav': None
        })
    
    # 添加KDJ指标
    if indicators.get('kdj', False) and 'kdj_k' in df.columns:
        panels.append({
            'panel': 4,
            'ylabel': 'KDJ',
            'secondary_y': False,
            'type': 'line',
            'mav': None
        })
    
    # 准备附加绘图
    addplot = []
    
    # 添加移动平均线
    if 'ma' in indicators and indicators['ma']:
        for period in indicators['ma']:
            if f'ma{period}' in df.columns:
                addplot.append(
                    mpf.make_addplot(df[f'ma{period}'], panel=0, color=f'C{period%10}', width=1)
                )
    
    # 添加MACD指标
    if indicators.get('macd', False) and 'macd' in df.columns:
        addplot.extend([
            mpf.make_addplot(df['macd'], panel=2, color='blue', width=1),
            mpf.make_addplot(df['macd_signal'], panel=2, color='red', width=1),
            mpf.make_addplot(df['macd_hist'], panel=2, color='green', type='bar', width=0.7)
        ])
    
    # 添加RSI指标
    if indicators.get('rsi', False) and 'rsi' in df.columns:
        addplot.append(
            mpf.make_addplot(df['rsi'], panel=3, color='purple', width=1)
        )
        # 添加RSI的30和70线
        addplot.extend([
            mpf.make_addplot([30] * len(df), panel=3, color='gray', linestyle='--', width=0.5),
            mpf.make_addplot([70] * len(df), panel=3, color='gray', linestyle='--', width=0.5)
        ])
    
    # 添加KDJ指标
    if indicators.get('kdj', False) and 'kdj_k' in df.columns:
        addplot.extend([
            mpf.make_addplot(df['kdj_k'], panel=4, color='blue', width=1),
            mpf.make_addplot(df['kdj_d'], panel=4, color='red', width=1),
            mpf.make_addplot(df['kdj_j'], panel=4, color='green', width=1)
        ])
    
    # 添加布林带
    if indicators.get('boll', False) and 'boll_mid' in df.columns:
        addplot.extend([
            mpf.make_addplot(df['boll_upper'], panel=0, color='gray', linestyle='--', width=0.5),
            mpf.make_addplot(df['boll_mid'], panel=0, color='blue', width=0.5),
            mpf.make_addplot(df['boll_lower'], panel=0, color='gray', linestyle='--', width=0.5)
        ])
    
    # 设置图表参数
    kwargs = {
        'type': 'candle',
        'style': s,
        'figsize': DEFAULT_FIGSIZE,
        'title': title,
        'returnfig': True,
        'addplot': addplot,
        'volume': 'volume' in df.columns,
        'panel_ratios': (4, 1) + (1,) * (len(panels) - 1) if len(panels) > 1 else None
    }
    
    # 绘制K线图
    fig, axes = mpf.plot(df, **kwargs)
    
    # 保存图表
    if savefig:
        plt.savefig(savefig)
        logger.info(f"图表已保存至 {savefig}")
    
    # 显示图表
    if show_figure:
        plt.show()
    
    return fig, axes
```

**函数解析：**
- 函数目的：绘制带有技术指标的K线图
- 参数说明：
  - `df`：包含OHLCV和技术指标数据的DataFrame
  - `title`：图表标题
  - `indicators`：要显示的指标字典
  - `savefig`：保存图表的文件路径
  - `show_figure`：是否显示图表
- 返回值：matplotlib图表对象和轴对象列表
- 主要步骤：
  1. 检查数据是否为空
  2. 设置图表样式
  3. 准备附加图表面板
  4. 准备附加绘图
  5. 设置图表参数
  6. 绘制K线图
  7. 保存图表（如果需要）
  8. 显示图表（如果需要）
  9. 返回图表对象和轴对象列表

3. **生成交互式HTML图表**

```python
def save_plot_to_html(ts_code, start_date=None, end_date=None, indicators=None):
    """
    生成交互式HTML图表
    
    Args:
        ts_code: 股票代码
        start_date: 开始日期，格式为'YYYY-MM-DD'
        end_date: 结束日期，格式为'YYYY-MM-DD'
        indicators: 要显示的指标字典，默认使用config中的DEFAULT_INDICATORS
        
    Returns:
        str: HTML文件路径，如果生成失败则返回None
    """
    # 准备数据
    df = prepare_data_for_visualization(ts_code, start_date, end_date)
    if df is None:
        logger.error("数据准备失败，无法生成HTML图表")
        return None
    
    # 计算技术指标
    df = calculate_all_indicators(df, indicators)
    if df is None:
        logger.error("指标计算失败，无法生成HTML图表")
        return None
    
    # 获取股票名称
    stock_name = get_stock_name(ts_code)
    
    # 创建图表目录
    charts_dir = os.path.join(BASE_DIR, 'charts')
    os.makedirs(charts_dir, exist_ok=True)
    
    # 构建文件名
    if start_date is None:
        start_date = df.index.min().strftime('%Y-%m-%d')
    if end_date is None:
        end_date = df.index.max().strftime('%Y-%m-%d')
    
    filename = f"{ts_code}_{start_date}_{end_date}.html"
    filepath = os.path.join(charts_dir, filename)
    
    try:
        # 创建图表
        fig = go.Figure()
        
        # 添加K线图
        fig.add_trace(go.Candlestick(
            x=df.index,
            open=df['open'],
            high=df['high'],
            low=df['low'],
            close=df['close'],
            name='K线'
        ))
        
        # 添加移动平均线
        if 'ma' in indicators and indicators['ma']:
            for period in indicators['ma']:
                if f'ma{period}' in df.columns:
                    fig.add_trace(go.Scatter(
                        x=df.index,
                        y=df[f'ma{period}'],
                        mode='lines',
                        name=f'MA{period}',
                        line=dict(width=1)
                    ))
        
        # 添加布林带
        if indicators.get('boll', False) and 'boll_mid' in df.columns:
            fig.add_trace(go.Scatter(
                x=df.index,
                y=df['boll_upper'],
                mode='lines',
                name='布林上轨',
                line=dict(width=1, dash='dash')
            ))
            fig.add_trace(go.Scatter(
                x=df.index,
                y=df['boll_mid'],
                mode='lines',
                name='布林中轨',
                line=dict(width=1)
            ))
            fig.add_trace(go.Scatter(
                x=df.index,
                y=df['boll_lower'],
                mode='lines',
                name='布林下轨',
                line=dict(width=1, dash='dash')
            ))
        
        # 设置图表布局
        title = f"{stock_name}({ts_code}) K线图 {start_date} 至 {end_date}"
        fig.update_layout(
            title=title,
            xaxis_title='日期',
            yaxis_title='价格',
            xaxis_rangeslider_visible=False,
            template='plotly_white'
        )
        
        # 保存为HTML文件
        fig.write_html(filepath)
        logger.info(f"HTML图表已保存至 {filepath}")
        
        return filepath
    
    except Exception as e:
        logger.error(f"生成HTML图表失败: {str(e)}")
        return None
```

**函数解析：**
- 函数目的：生成交互式HTML图表
- 参数说明：
  - `ts_code`：股票代码
  - `start_date`：开始日期
  - `end_date`：结束日期
  - `indicators`：要显示的指标字典
- 返回值：HTML文件路径，如果生成失败则返回None
- 主要步骤：
  1. 准备数据
  2. 计算技术指标
  3. 获取股票名称
  4. 创建图表目录
  5. 构建文件名
  6. 创建图表
  7. 添加K线图
  8. 添加技术指标
  9. 设置图表布局
  10. 保存为HTML文件
  11. 返回HTML文件路径

## 第三章：实训步骤指导

### 3.1 获取股票数据

#### 步骤1：获取股票列表

在这一步，我们将获取当前市场上所有上市股票的基本信息，包括股票代码、名称、所属行业等。

1. **打开命令提示符(CMD)**
   - 按下`Win + R`键，输入`cmd`，按回车打开命令提示符

2. **进入项目目录**
   - 使用`cd`命令进入项目目录，例如：
   ```
   cd D:\tushare\stock_training
   ```

3. **执行获取股票列表命令**
   - 输入以下命令：
   ```
   python main.py --fetch --update-stock-list
   ```
   - 命令执行过程中，会显示类似以下的输出：
   ```
   2023-04-01 10:00:00 - main - INFO - 获取股票基本信息...
   2023-04-01 10:00:05 - data_fetcher - INFO - 保存4800条股票数据到 D:\tushare\stock_training\data\stock_basic.csv
   2023-04-01 10:00:05 - main - INFO - 共获取到 4800 只股票的基本信息
   ```

4. **验证结果**
   - 执行成功后，将在`data`目录下生成`stock_basic.csv`文件
   - 可以使用Excel或文本编辑器打开该文件查看内容
   - 文件内容示例：
   ```
   ts_code,symbol,name,area,industry,market,list_date,is_hs,delist_date
   000001.SZ,000001,平安银行,深圳,银行,主板,19910403,S,
   000002.SZ,000002,万科A,深圳,全国地产,主板,19910129,S,
   ...
   ```

#### 步骤2：获取特定股票的历史数据

在这一步，我们将获取特定股票（以平安银行为例）的历史行情数据。

1. **执行获取股票历史数据命令**
   - 在命令提示符中输入以下命令：
   ```
   python main.py --fetch --code 000001.SZ
   ```
   - 命令执行过程中，会显示类似以下的输出：
   ```
   2023-04-01 10:10:00 - main - INFO - 获取 000001.SZ 的日线数据...
   2023-04-01 10:10:05 - data_fetcher - INFO - 获取股票 000001.SZ 从 20200101 到 20230401 的日线数据
   2023-04-01 10:10:10 - data_fetcher - INFO - 保存股票 000001.SZ 数据，共 800 条记录
   2023-04-01 10:10:10 - main - INFO - 共获取到 800 条日线数据
   ```

2. **验证结果**
   - 执行成功后，将在`data/daily`目录下生成`000001.SZ.csv`文件
   - 可以使用Excel或文本编辑器打开该文件查看内容
   - 文件内容示例：
   ```
   ts_code,trade_date,open,high,low,close,pre_close,change,pct_chg,vol,amount
   000001.SZ,20230331,14.50,14.65,14.42,14.58,14.48,0.10,0.6906,43256.16,629282.377
   000001.SZ,20230330,14.52,14.60,14.40,14.48,14.55,-0.07,-0.4811,35687.97,517212.048
   ...
   ```

### 3.2 数据可视化

#### 步骤1：绘制基本K线图

在这一步，我们将使用获取到的股票数据绘制基本K线图。

1. **执行绘制K线图命令**
   - 在命令提示符中输入以下命令：
   ```
   python main.py --visualize --code 000001.SZ
   ```
   - 命令执行过程中，会显示类似以下的输出：
   ```
   2023-04-01 10:20:00 - main - INFO - 可视化 平安银行(000001.SZ) 从 2022-04-01 到 2023-04-01 的数据...
   2023-04-01 10:20:05 - visualization - INFO - 正在绘制K线图...
   ```
   - 执行完成后，会弹出一个窗口显示K线图

2. **指定日期范围**
   - 默认显示最近一年的数据，你也可以指定日期范围：
   ```
   python main.py --visualize --code 000001.SZ --start 2023-01-01 --end 2023-12-31
   ```
   - 这将只显示2023年1月1日至2023年12月31日的数据

3. **K线图解读**
   - K线图中，红色表示上涨，绿色表示下跌（中国股市传统颜色）
   - 每个K线代表一个交易日的价格变动：
     - 上影线：当日最高价
     - 下影线：当日最低价
     - 实体上端：开盘价（下跌日）或收盘价（上涨日）
     - 实体下端：收盘价（下跌日）或开盘价（上涨日）
   - 图表下方显示成交量柱状图

#### 步骤2：生成交互式HTML图表

1. **执行生成HTML图表命令**
   - 在命令提示符中输入以下命令：
   ```
   python main.py --visualize --code 000001.SZ --html
   ```
   - 命令执行过程中，会显示类似以下的输出：
   ```
   2023-04-01 10:30:00 - main - INFO - 可视化 平安银行(000001.SZ) 从 2022-04-01 到 2023-04-01 的数据...
   2023-04-01 10:30:05 - visualization - INFO - 正在生成HTML图表...
   2023-04-01 10:30:10 - visualization - INFO - HTML图表已保存至 D:\tushare\stock_training\charts\000001.SZ_2022-04-01_2023-04-01.html
   2023-04-01 10:30:10 - main - INFO - HTML图表已保存至: D:\tushare\stock_training\charts\000001.SZ_2022-04-01_2023-04-01.html
   ```

2. **查看HTML图表**
   - 执行成功后，将在`charts`目录下生成HTML文件
   - 使用浏览器打开该HTML文件
   - 交互式图表支持以下操作：
     - 鼠标悬停：显示详细数据
     - 鼠标滚轮：缩放图表
     - 鼠标拖动：平移图表
     - 双击：重置视图
     - 右上角工具栏：保存图片、放大/缩小、自动缩放等

### 3.3 运行示例脚本

项目提供了一个完整的示例脚本`example.py`，展示了如何使用各个模块的功能：

1. **执行示例脚本**
   - 在命令提示符中输入以下命令：
   ```
   python example.py
   ```
   - 脚本执行过程中，会显示各个步骤的输出信息

2. **示例脚本执行流程**
   - **步骤1: 获取股票基本信息**
     ```
     步骤1: 获取股票基本信息
     股票列表已存在，读取现有数据
     共有 4800 只股票
     ```
   
   - **步骤2: 获取特定股票的日线数据**
     ```
     步骤2: 获取特定股票的日线数据
     获取 平安银行(000001.SZ) 的日线数据...
     数据已存在，无需重新下载
     ```
   
   - **步骤3: 数据处理与准备**
     ```
     步骤3: 数据处理与准备
     处理 2022-04-01 至 2023-04-01 的数据
     成功准备 245 条数据记录
     数据预览:
                  ts_code      open      high       low     close  pre_close    change    pct_chg        vol       amount
     trade_date                                                                                                          
     2022-04-01  000001.SZ  12.8000  12.8500  12.5700  12.6100   12.7900  -0.18000  -1.40735  49642.51  6.318280e+05
     2022-04-06  000001.SZ  12.5900  12.7000  12.5500  12.6600   12.6100   0.05000   0.39651  31276.55  3.957789e+05
     2022-04-07  000001.SZ  12.6500  12.7000  12.5600  12.5700   12.6600  -0.09000  -0.71090  26542.37  3.353856e+05
     2022-04-08  000001.SZ  12.5700  12.6300  12.4900  12.5400   12.5700  -0.03000  -0.23866  21344.52  2.681532e+05
     2022-04-11  000001.SZ  12.5000  12.5000  12.3400  12.3600   12.5400  -0.18000  -1.43541  31700.95  3.936204e+05
     ```
   
   - **步骤4: 计算技术指标**
     ```
     步骤4: 计算技术指标
     计算完成的指标:
     ['volume_ma5', 'volume_ma10', 'ma5', 'ma10', 'ma20', 'ma30', 'ma60', 'macd', 'macd_signal', 'macd_hist', 'rsi', 'kdj_k', 'kdj_d', 'kdj_j', 'boll_mid', 'boll_std', 'boll_upper', 'boll_lower']
     
     单独计算各指标示例:
     MACD指标列:
     ['macd', 'macd_signal', 'macd_hist']
     RSI指标列:
     ['rsi']
     KDJ指标列:
     ['kdj_k', 'kdj_d', 'kdj_j']
     布林带指标列:
     ['boll_mid', 'boll_std', 'boll_upper', 'boll_lower']
     ```
   
   - **步骤5-7: 可视化**
     ```
     步骤5: 可视化 - 基本K线图
     绘制基本K线图...
     
     步骤6: 可视化 - 带技术指标的K线图
     绘制带技术指标的K线图...
     
     步骤7: 使用便捷函数绘制完整图表
     绘制完整K线图与技术指标...
     ```
     - 执行这些步骤时，会弹出图表窗口
   
   - **步骤8: 保存为HTML交互式图表**
     ```
     步骤8: 保存为HTML交互式图表
     生成交互式HTML图表...
     HTML图表已保存至: D:\tushare\stock_training\charts\000001.SZ_2022-04-01_2023-04-01.html
     请在浏览器中打开此文件查看交互式图表
     
     示例运行完成!
     您可以尝试修改股票代码、日期范围或技术指标参数来进行更多实验
     ```

## 第四章：实训任务详解

### 任务一：修改配置参数

1. 打开`config.py`文件
2. 修改以下参数：
   - `START_DATE`：修改为你想要的起始日期
   - `DEFAULT_INDICATORS`：尝试修改默认显示的技术指标

### 任务二：获取多只股票数据

1. 查看`stock_basic.csv`文件，选择3-5只不同行业的股票
2. 使用`main.py`的`--fetch`命令获取这些股票的历史数据
3. 验证数据是否成功保存到`data/daily`目录

### 任务三：计算和分析技术指标

1. 打开`indicators.py`文件，阅读各个技术指标的计算方法
2. 创建一个新的Python脚本`my_analysis.py`
3. 在脚本中实现以下功能：
   - 加载一只股票的数据
   - 计算MA、MACD、RSI指标
   - 分析这些指标的变化趋势
   - 输出分析结果

### 任务四：自定义可视化

1. 打开`visualization.py`文件，阅读可视化相关函数
2. 创建一个新的Python脚本`my_visualization.py`
3. 在脚本中实现以下功能：
   - 加载一只股票的数据
   - 计算你感兴趣的技术指标
   - 创建自定义的可视化图表
   - 保存图表为图片或HTML文件

## 第五章：常见问题与解决方案

### 5.1 安装依赖问题

**问题**：安装依赖库时出现错误

**解决方案**：
1. 确保你的网络连接正常
2. 尝试使用国内镜像源：
   ```
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```
3. 如果某个库安装失败，可以单独安装：
   ```
   pip install 库名 -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

### 5.2 Tushare API问题

**问题**：使用Tushare API时出现错误或无法获取数据

**解决方案**：
1. 检查你的Token是否正确配置
2. 检查你的Tushare账号积分是否足够（部分数据需要积分）
3. 尝试减少请求频率，避免触发API限制

### 5.3 数据处理问题

**问题**：数据处理过程中出现错误

**解决方案**：
1. 检查数据文件是否存在
2. 检查数据格式是否正确
3. 使用`print`或日志输出中间结果，定位问题

### 5.4 可视化问题

**问题**：图表显示不正常或无法生成

**解决方案**：
1. 检查数据是否包含必要的列（如OHLCV数据）
2. 检查日期范围是否有效
3. 尝试使用不同的可视化参数

## 第六章：进阶学习资源

### 6.1 Python数据分析

- [Python数据分析基础教程](https://www.runoob.com/python/python-tutorial.html)
- [Pandas官方文档](https://pandas.pydata.org/docs/)
- [NumPy官方文档](https://numpy.org/doc/stable/)

### 6.2 金融数据分析

- [Tushare官方文档](https://tushare.pro/document/1)
- [量化投资基础知识](https://www.joinquant.com/help/api/help#name:api)
- [技术指标计算方法详解](https://www.investopedia.com/terms/t/technicalindicator.asp)

### 6.3 数据可视化

- [Matplotlib官方文档](https://matplotlib.org/stable/contents.html)
- [mplfinance文档](https://github.com/matplotlib/mplfinance)
- [Plotly官方文档](https://plotly.com/python/)

## 结语

通过本实训项目，你已经学习了如何使用Python获取股票数据、处理数据、计算技术指标并进行可视化展示。这些技能不仅适用于股票数据分析，也可以应用于其他领域的数据分析工作。希望你能在实践中不断提升自己的编程能力和数据分析能力，为未来的学习和工作打下坚实基础。

祝你学习愉快！